#/bin/bash

ARGS=1
E_BADARGS=65

UNCONFIGURED_EXT="vhd.kcm_unconfig"
CONFIGURED_EXT="vhd"
IMPLS="beh beh2 structural_mm"
FILES="1st_order_iir_filter 2nd_order_iir_filter cordic_atan fa freq2phase integrator kcm_integrator park_transform phase_loop"

print_help ()
{
    echo "Usage: $0 <implementation>"
    echo "   Available implementations: $IMPLS"
}

if [ $# -ne "$ARGS" ]
then
    print_help
    exit $E_BADARGS
fi

for impl in $IMPLS; do
    if [[ "$impl" == "$1" ]]
    then
	found_impl=1
	break
    fi
done

if [[ ! -n $found_impl ]]
then
    print_help
    exit $E_BADARGS
fi

echo "Configuring KCM components to use '$impl' implementation"
for file in $FILES; do
    dest_file=file."$CONFIGURED_EXT"
    echo "  Setting KCM implementation in $dest_file";
    if [[ -e $dest_file ]]
    then
	echo "    destination file exists, making backup"
	cp "$dest_file" "$dest_file".backup
    fi
    cat "$file"."$UNCONFIGURED_EXT" | sed s/kcm\(CONFIG_architecture\)/kcm\("$impl"\)/ > $dest_file
done